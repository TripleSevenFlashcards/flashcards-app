<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Flashcards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --bg1:#0c2146; --bg2:#0f356e; --panel:#ffffff; --accent:#2b8cff; --text:#0a0a0a; --muted:#5c646d;
      --ok:#1b8a3a; --bad:#b02a37; --next:#0d2c6d;
      --btnw:120px;
    }

    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, #1a3d7a 0%, transparent 60%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff; display:flex; flex-direction:column; align-items:center;
      padding-top: env(safe-area-inset-top);
      padding-bottom: calc(env(safe-area-inset-bottom) + 0px);
      -webkit-text-size-adjust: 100%; -webkit-tap-highlight-color: transparent;
    }

    .topbar{width:100%; max-width:1100px; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 16px;}
    .leftGroup{display:flex; align-items:center; gap:10px}
    .logo{height:36px}
    .brand{font-size:18px; font-weight:700; letter-spacing:.2px}
    .hamburger{display:none; align-items:center; justify-content:center; width:44px; height:44px; border-radius:8px; border:2px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); color:#fff; cursor:pointer;}
    .hamburger:focus{outline:2px solid #88b4ff; outline-offset:2px}

    .wrap{width:100%; max-width:1100px; display:grid; grid-template-columns: 280px 1fr; gap:14px; padding:0 16px 16px;}
    .panel{background:var(--panel); color:var(--text); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); max-height: calc(100svh - 140px); overflow:auto; border: none;}
    .left{padding:12px; display:flex; flex-direction:column}
    .right{padding:16px; display:flex; flex-direction:column}

    .sectionTitle{font-size:14px; font-weight:800; letter-spacing:.3px; color:#2b3a4b; text-transform:uppercase}
    .muted{color:#5c646d}

    .catlist{display:flex; flex-direction:column; gap:6px; margin:10px 0}
    .checkboxline{display:flex; align-items:center; gap:10px; font-weight:600}
    .checkboxline input{width:18px; height:18px}

    .imgbox{display:none; margin:10px 0}
    .imgbox img{max-width:100%; height:auto; display:block; border-radius:8px; border:1px solid #d9e1ee}

    .q{font-size: clamp(18px, 3.2vw, 22px); font-weight:700;}
    .a{display:none; color:#1d2630; background:#f6f8fb; border:1px dashed #d9e1ee; border-radius:10px; padding:14px; white-space:pre-wrap}

    .controls-row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap}

    /* Utility for uniform, light-grey buttons; does not override global button styles */
    .u-btn{
      background:#e5e7eb; color:#000; border:1px solid #d1d5db;
      min-height:40px; padding:6px 10px; width:var(--btnw); border-radius:8px; font-weight:600; font-size:14px; cursor:pointer;
    }

    .statline{display:flex; gap:10px; margin:8px 0 12px; flex-wrap:wrap}
    .chip{background:#0c2146; color:#e8f1ff; border:1px solid #2a4f8a; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;}

    .scrim{position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:opacity .2s ease;}
    .scrim.show{opacity:1; pointer-events:auto}

    @media (max-width:900px){
      .wrap{grid-template-columns:1fr}
      .left{position:fixed; inset:0 auto 0 0; width:min(360px, 90vw); transform: translateX(-120%); transition: transform .2s ease}
      .left.open{transform: translateX(0)}
      .hamburger{display:flex}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="leftGroup">
      <button id="menuBtn" class="hamburger" aria-label="Open categories">
        <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg>
      </button>
      <img class="logo" src="/static/logo.jpg" alt="logo">
      <div class="brand">Triple Seven Aviation Flashcards</div>
    </div>
  </div>

  <div id="scrim" class="scrim" hidden></div>

  <div class="wrap">
    <!-- LEFT -->
    <div id="catDrawer" class="panel left" role="dialog" aria-label="Categories" aria-modal="true" tabindex="-1">
      <div class="sectionTitle">Categories</div>
      <div id="categories" class="catlist"></div>

      <div class="sectionTitle" style="margin-top:10px;">Session Controls</div>
      <div class="btnrow">
        <button id="restart" class="u-btn">Restart</button>
        <button id="unhide" class="u-btn">Unhide All</button>
      </div>

      <div class="sectionTitle" style="margin-top:10px;">Stats</div>
      <div class="statline">
        <span class="chip" id="statTotal">Total: 0</span>
        <span class="chip" id="statFiltered">Filtered: 0</span>
        <span class="chip" id="statHidden">Hidden: 0</span>
      </div>

      <div class="muted" id="status">Loading…</div>
    </div>

    <!-- RIGHT -->
    <div class="panel right">
      <div id="qcat" class="muted"></div>
      <div class="q" id="q">…</div>

      <div class="imgbox" id="qimgbox"><img id="qimg" alt=""></div>

      <div class="answrap" id="answrap">
        <div class="a" id="ans"></div>
        <div id="aimgbox" class="imgbox"><img id="aimg" alt=""></div>
      </div>

      <div class="controls-row" style="margin-top:10px;">
        <button id="prev" class="u-btn">Previous</button>
        <div class="btnrow">
          <button id="show" class="u-btn">Show Answer</button>
          <button id="hide" class="u-btn">Hide Slide</button>
          <button id="next" class="u-btn">Next</button>
        </div>
      </div>

      <footer><div id="progress" class="muted">0 / 0</div></footer>
    </div>
  </div>

  <script>
    document.addEventListener('touchstart', function(){}, {passive:true});

    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const statusEl = $('#status');
    const qEl = $('#q'), ansEl = $('#ans'), qcatEl = $('#qcat');
    const qimg = $('#qimg'), aimg = $('#aimg');
    const answrap = $('#answrap');
    const statTotal = $('#statTotal'), statFiltered = $('#statFiltered'), statHidden = $('#statHidden');
    const categoriesEl = $('#categories');
    const drawer = $('#catDrawer');
    const scrim  = $('#scrim');
    const menuBtn = $('#menuBtn');
    const btnShow = $('#show'), btnNext = $('#next'), btnPrev = $('#prev'), btnHide = $('#hide');
    const btnRestart = $('#restart'), btnUnhide = $('#unhide');

    // State
    let fullDeck = [];
    let deck = [];
    let cats = [];
    let idx = 0;
    let showing = false;
    let hiddenIds = new Set();

    const uniq = (arr) => [...new Set(arr)];
    const normCard = (c) => ({
      id: c.id,
      category: c.category || 'General',
      question: c.question || '',
      answer: c.answer || '',
      image: c.image || '',
      answer_image: c.answer_image || ''
    });

    function buildCategoryUI(){
      categoriesEl.innerHTML = '';
      cats.forEach(cat => {
        const line = document.createElement('label');
        line.className = 'checkboxline';
        line.innerHTML = \`
          <input type="checkbox" data-cat value="\${cat}" checked />
          <span>\${cat}</span>
        \`;
        categoriesEl.appendChild(line);
      });
      categoriesEl.addEventListener('change', () => {
        refilter(); idx = 0; showing = false; render();
      }, {once:true});
    }

    function refilter(){
      const chosen = $$('input[data-cat]:checked').map(i => i.value);
      deck = fullDeck.filter(c => chosen.includes(c.category) && !hiddenIds.has(c.id));
      statTotal.textContent = 'Total: ' + fullDeck.length;
      statFiltered.textContent = 'Filtered: ' + deck.length;
      statHidden.textContent = 'Hidden: ' + hiddenIds.size;
    }

    function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

    function render(){
      const cur = deck[idx];
      $('#progress').textContent = \`\${deck.length ? (idx+1) : 0} / \${deck.length}\`;
      if(!cur){
        $('#qcat').textContent = '';
        $('#q').textContent = 'No cards.';
        answrap.style.display = 'none';
        $('#qimgbox').style.display = 'none';
        $('#aimgbox').style.display = 'none';
        return;
      }
      $('#qcat').textContent = cur.category;
      $('#q').textContent = cur.question || '—';
      answrap.style.display = showing ? 'block' : 'none';

      if(cur.image){
        $('#qimg').src = cur.image;
        $('#qimgbox').style.display = 'block';
      }else{
        $('#qimg').removeAttribute('src');
        $('#qimgbox').style.display = 'none';
      }

      $('#ans').textContent = cur.answer || '';
      if(cur.answer_image){
        $('#aimg').src = cur.answer_image;
        $('#aimgbox').style.display = 'block';
      }else{
        $('#aimg').removeAttribute('src');
        $('#aimgbox').style.display = 'none';
      }
    }

    btnShow.onclick = () => { showing = !showing; render(); };
    btnNext.onclick = () => { idx = clamp(idx+1, 0, Math.max(0, deck.length-1)); showing=false; render(); };
    btnPrev.onclick = () => { idx = clamp(idx-1, 0, Math.max(0, deck.length-1)); showing=false; render(); };

    btnRestart.onclick = () => {
      for (let i = fullDeck.length-1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [fullDeck[i], fullDeck[j]] = [fullDeck[j], fullDeck[i]]; }
      refilter(); idx = 0; showing = false; render();
    };

    btnHide.onclick = () => {
      const cur = deck[idx]; if(!cur) return;
      hiddenIds.add(cur.id);
      refilter();
      idx = Math.min(idx, Math.max(0, deck.length-1));
      showing = false;
      render();
    };

    btnUnhide.onclick = () => { hiddenIds.clear(); refilter(); idx = 0; showing = false; render(); };

    // Drawer
    function openDrawer(){ drawer.classList.add('open'); scrim.classList.add('show'); scrim.hidden = false; drawer.focus(); }
    function closeDrawer(){ drawer.classList.remove('open'); scrim.classList.remove('show'); scrim.hidden = true; }
    menuBtn.onclick = openDrawer;
    scrim.onclick = closeDrawer;

    // Load cards.json
    (async function(){
      try{
        const res = await fetch('/cards/cards.json', {cache:'no-store'});
        const data = await res.json();
        fullDeck = (Array.isArray(data) ? data : (data.cards || [])).map(normCard);
        if (!fullDeck.length) throw new Error('No cards in cards.json');
        cats = uniq(fullDeck.map(c => c.category));
        buildCategoryUI();
        refilter(); idx = 0; showing = false; render();
        statusEl.textContent = \`Loaded \${fullDeck.length} cards.\`;
      }catch(e){
        statusEl.textContent = 'Failed to load cards: ' + e.message;
        qEl.textContent = 'Loading failed.';
      }
    })();
  </script>
</body>
</html>
